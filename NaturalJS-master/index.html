<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>NaturalJS basic example</title>
<script src="../js/d3.v2.min.js"></script>
<script src="http://code.jquery.com/jquery-1.10.2.min.js"></script>
<script src="natural.js"></script>
<script src="removeStopWords.js"></script>
<style>
	span.keyword{
	color:red;
	}
</style>
</head>
<body>
	<div id="search">
		<form>
			<input id="keywords" type="text" title="keywords to map"> <input
				type="button" onclick="search()" value="Go">
		</form>
		<select id="match" multiple>
		<span style="color:#fee0d2">family</span>
			<option>
				<span class="keyword">sadfa</span>sadfdsa
			</option>
		</select>
	</div>
	<script>
	Array.prototype.getUnique = function(){
	   var u = {}, a = [];
	   for(var i = 0, l = this.length; i < l; ++i){
	      if(u.hasOwnProperty(this[i])) {
	         continue;
	      }
	      a.push(this[i]);
	      u[this[i]] = 1;
	   }
	   return a;
	}
	
	var description="Percent; HOUSEHOLDS BY TYPE - Family households (families) - Female householder, \
	no husband present, family - With own children under 18 years"
	/* log(s.removeStopWords());
	s=s.removeStopWords(); */
	var tokenizer = new natural.WordTokenizer();
	var tokensByWords=tokenizer.tokenize(description.toLowerCase());		// words should be words from all descriptions
	tokensByWords=tokensByWords.getUnique();
	
	var scoreByWords=[];		//tokensByWords
	log(tokensByWords)

	function search(){
		var keywords=$("#keywords").val().toLowerCase();
		var tokensByKeywords=tokenizer.tokenize(keywords);
		tokensByKeywords=tokensByKeywords.getUnique();
		//log(tokensByKeywords)
		// rules: 
		// soundsLike	score=.9
		// JaroWinklerDistance >= .9
		scoreByWords=[];		// score for all words
		tokensByWords.forEach(function(w){
			tokensByKeywords.forEach(function(kw){		//JaroWinklerDistance, [0,1], the large the better 0.9 is more robust
				// form
				var strSimilarityScore=natural.JaroWinklerDistance(kw,w);
				if(strSimilarityScore>0.8){
					scoreByWords[w]=scoreByWords[w] || 0;
					scoreByWords[w]=strSimilarityScore > scoreByWords[w]?strSimilarityScore :  scoreByWords[w];
				}
				// sound
				var phoneSimilarityScore=natural.Metaphone.compare(kw,w);
				if(phoneSimilarityScore){
					scoreByWords[w]=scoreByWords[w] || 0;
					scoreByWords[w]=phoneSimilarityScore > scoreByWords[w]?0.6 :  scoreByWords[w];
				}
			});
		});
		
		fields.forEach(function(d){
			d.descriptionHTML=d.description;
			var sumscore=0;
			var tokensByDescription=tokenizer.tokenize(d.Description);	// 
			tokensByDescription=tokensByDescription.getUnique();
			tokensByDescription.forEach(function(token){
				if(scoreByWords[token]>0){
					d.score=scoreByWords[token];
					d.descriptionHTML.replace(token,"<span class='keyword'>"+token+"</span>")
				}else{
					d.score=0;
				}
			});
		});
		// sort fields
		fields.sort(function(a,b){
			return b.score-a.score;		// <0, a comes first
		})
		selectedFields=fields.splice(0,5);
		// add top 10 fields to the list
		d3.select("#match").selectAll("li").remove()
		
		d3.select("#match").selectAll("li")
			.enter(fields)
			.append("li")
			.attr("value",function(d){
				return d.id;
			})
			.text(function(d){
				return d.descriptionHTML;
			})
			.on("click",function(e){
				field = this.value;		// this is the current DOM select
				//log(field);
				location.hash = "#" + [ field.id, year ].join("/");		// #popest/2011, in our case it will be all #field/2012 
			})
			
		log(scoreByWords);
	}

	
	function log(s){
		console.log(s);
	}
</script>
</body>
</html>
